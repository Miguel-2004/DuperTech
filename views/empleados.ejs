<!DOCTYPE html>
<html lang="es">
<head>
    <title>Empleados</title>
    <%- include('includes/head') %>
    <style>
        .box-centered {
            width: 80%;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
        }

        .table.is-fullwidth.is-striped.is-hoverable {
            width: 100%;
            margin-bottom: 1rem;
            color: #363636;
            border-collapse: collapse;
            border-spacing: 0;
        }

        .table th,
        .table td {
            padding: 0.75em 1em;
            border-bottom: 2px solid #dbdbdb;
        }

        .table thead th {
            border-bottom: 3px solid #dbdbdb;
        }

        .table.is-striped tbody tr:nth-child(odd) {
            background-color: #f9f9f9;
        }

        .table.is-hoverable tbody tr:hover {
            background-color: #f5f5f5;
        }

        .pagination-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            padding: 20px;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            max-width: 500px;
            width: 100%;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
    </style>
</head>
<body>

    <%- include('includes/sidebar') %>

    <div class="container">
        <section class="section">
            <div class="box box-centered">
                <h1 class="title has-text-centered">Trabajadores</h1>

                <!-- Search -->
                <form method="GET" action="<%= process.env.PATH_SERVER %>empleado/empleados">
                    <div class="field has-addons">
                        <div class="control has-icons-left is-expanded">
                            <input class="input" type="text" placeholder="Buscar" value="<%= searchQuery %>" name="search">
                            <span class="icon is-small is-left">
                                <i class="fas fa-search"></i>
                            </span>
                        </div>
                    </div>
                </form>

                <!-- Tabla de trabajadores -->
                <table class="table is-fullwidth is-striped is-hoverable">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Teléfono</th>
                            <th>Usuario</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% Trabajadores.forEach((trabajador) => { %>
                            <tr>
                                <td><%= trabajador.Nombre_Empleado %></td>
                                <td><%= trabajador.Telefono_Empleado %></td>
                                <td><%= trabajador.Usuario %></td>

                                <!-- Menú desplegable de estado -->
                                <td>
                                    <form action="<%= process.env.PATH_SERVER %>empleado/empleados/actualizarEstado" method="POST">
                                        <input type="hidden" name="idEmpleado" value="<%= trabajador.ID_Empleado %>">
                                        <select name="estado" onchange="this.form.submit()">
                                            <option value="1" <%= trabajador.estado === 1 ? 'selected' : '' %>>Activo</option>
                                            <option value="0" <%= trabajador.estado === 0 ? 'selected' : '' %>>Inactivo</option>
                                        </select>
                                    </form>
                                </td>

                                <td>
                                    <button class="button is-small is-link is-light edit-button" 
                                    onclick="mostrarPopupEditar('<%= trabajador.Nombre_Empleado %>', 
                                            '<%= trabajador.ID_Empleado %>', 
                                            '<%= trabajador.Telefono_Empleado %>', 
                                            '<%= trabajador.Usuario %>', 
                                            '<%= trabajador.Contrasenia %>', 
                                            '<%= trabajador.ID_Establecimiento %>', 
                                            '<%= trabajador.ID_Admin %>')">Editar</button>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>

                <!-- Paginación -->
                <div class="pagination-container">
                    <% if (currentPage > 1) { %>
                        <a href="?page=<%= currentPage - 1 %>" class="button is-link pagination-button">
                            <span class="icon"><i class="fas fa-arrow-left"></i></span>
                        </a>
                    <% } %>

                    <span class="pagination-info">Página <%= currentPage %> de <%= totalPages %></span>

                    <% if (currentPage < totalPages) { %>
                        <a href="?page=<%= currentPage + 1 %>" class="button is-link pagination-button">
                            <span class="icon"><i class="fas fa-arrow-right"></i></span>
                        </a>
                    <% } %>
                </div>
            </div>

            <!-- Botón para añadir trabajador -->
            <div class="has-text-centered mt-5">
                <button class="button is-success is-medium" id="addWorkerBtn">Añadir</button>
            </div>
        </section>

        <!-- Modal para añadir trabajador -->
        <div class="modal" id="addWorkerModal">
            <div class="modal-background"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">Añadir Trabajador</p>
                    <button class="delete" aria-label="close" id="closeModalBtn"></button>
                </header>
                <section class="modal-card-body">
                    <form id="formularioEmpleado" action="<%= process.env.PATH_SERVER %>empleado/empleados/nuevo" method="POST">
                        <div class="field">
                            <label class="label">Nombre del Trabajador</label>
                            <div class="control">
                                <input class="input" type="text" name="nombre" placeholder="Nombre" required>
                            </div>
                        </div>
                        <div class="field">
                            <label class="label">Teléfono</label>
                            <div class="control">
                                <input class="input" type="text" name="telefono" placeholder="Teléfono" required>
                            </div>
                        </div>
                        <div class="field">
                            <label class="label">Usuario</label>
                            <div class="control">
                                <input class="input" type="text" name="usuario" id="usuarioInput" placeholder="Usuario" required>
                            </div>
                        </div>
                        <div class="field">
                            <label class="label">Password</label>
                            <div class="control">
                                <input class="input" type="password" name="password" placeholder="Contraseña" required>
                            </div>
                        </div>
                        <div class="field">
                            <label class="label">Establecimiento</label>
                            <div class="select">
                                <select name="ID_Establecimiento" id="nuevoSelectEstablecimiento" required>
                                    <% establecimiento.forEach((est) => { %>
                                        <option value="<%= est.ID_Establecimiento %>">
                                            <%= est.Nombre_Establecimiento %>
                                        </option>
                                    <% }); %>
                                </select>
                            </div>
                        </div>
                        <div class="field">
                            <label class="label">Administrador</label>
                            <div class="select">
                                <select name="id_Admin" id="nuevoAdminSelect" required>
                                    <% admin.forEach((admin) => { %>
                                        <option value="<%= admin.ID_Admin %>">
                                            <%= admin.Nombre %>
                                        </option>
                                    <% }); %>
                                </select>
                            </div>
                        </div>

                        <footer class="modal-card-foot">
                            <button class="button is-success">Guardar</button>
                        </footer>
                    </form>
                </section>
            </div>
        </div>

        <!-- Superposición de fondo -->
        <div id="popupOverlay" class="popup-overlay"></div>

        <!-- Pop-up de Edición -->
        <div class="popup" id="editPopup" style="display: none;">
            <button id="closeEditPopup" class="delete" style="position: absolute; top: 10px; right: 10px;"></button>
            <h2 class="title is-4 has-text-link">Editar detalles del trabajador</h2>

            <form id="editar_info" action="<%= process.env.PATH_SERVER %>empleado/empleados/editar" method="post">
                <input type="hidden" id="editIDEmpleado" name="ID_Empleado">
                <div class="field">
                    <label class="label">Nombre</label>
                    <div class="control">
                        <input id="editNombre" class="input" type="text" name="nombre" placeholder="Nombre del trabajador" required>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Teléfono</label>
                    <div class="control">
                        <input id="editTelefono" class="input" type="text" name="telefono" placeholder="Teléfono" required>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Usuario</label>
                    <div class="control">
                        <input id="editUsuario" class="input" type="text" name="usuario" placeholder="Usuario" readonly>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Contraseña</label>
                    <div class="control">
                        <input id="editContrasenia" class="input" type="password" name="contrasena" placeholder="Contraseña" readonly>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Establecimiento</label>
                    <div class="select">
                        <select id="editIDEstablecimiento" name="ID_Establecimiento" required>
                            <% establecimiento.forEach((est) => { %>
                                <option value="<%= est.ID_Establecimiento %>">
                                    <%= est.Nombre_Establecimiento %>
                                </option>
                            <% }); %>
                        </select>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Administrador</label>
                    <div class="select">
                        <select name="id_Admin" id="nuevoAdminSelect" required>
                            <% admin.forEach((admin) => { %>
                                <option value="<%= admin.ID_Admin %>">
                                    <%= admin.Nombre %>
                                </option>
                            <% }); %>
                        </select>
                    </div>
                </div>
                <button class="button is-link is-fullwidth mt-4" type="submit">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <script>
        const addWorkerBtn = document.getElementById('addWorkerBtn');
        const addWorkerModal = document.getElementById('addWorkerModal');
        const closeModalBtn = document.getElementById('closeModalBtn');

        addWorkerBtn.addEventListener('click', () => {
            addWorkerModal.classList.add('is-active');
        });

        closeModalBtn.addEventListener('click', () => {
            addWorkerModal.classList.remove('is-active');
        });

        function mostrarPopupEditar(nombre, idEmpleado, telefono, usuario, contrasenia, idEstablecimiento, idAdmin) {
            document.getElementById("editPopup").style.display = "block";
            document.getElementById("editNombre").value = nombre;
            document.getElementById("editIDEmpleado").value = idEmpleado;
            document.getElementById("editTelefono").value = telefono;
            document.getElementById("editUsuario").value = usuario;
            document.getElementById("editContrasenia").value = contrasenia;
            document.getElementById("editIDEstablecimiento").value = idEstablecimiento;
            document.getElementById("editIDAdmin").value = idAdmin;
        }

        document.getElementById("closeEditPopup").addEventListener("click", function() {
            document.getElementById("editPopup").style.display = "none";
        });

        function actualizarEstado(idEmpleado, nuevoEstado) {
            fetch('/empleados/actualizarEstado', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    idEmpleado: idEmpleado,
                    estado: nuevoEstado
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Estado actualizado con éxito');
                    window.location.reload();
                } else {
                    alert('Error al actualizar el estado');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        window.onload = function() {
            fetch('/empleados/obtenerUltimoUsuario')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('usuarioInput').value = data.ultimoUsuario + 1;
                })
                .catch(error => console.error('Error al obtener el último usuario:', error));
        };

        function actualizarNuevoAdmin() {
            const establecimientoID = document.getElementById('nuevoSelectEstablecimiento').value;
            fetch(`/empleados/obtenerAdminPorEstablecimiento/${establecimientoID}`)
                .then(response => response.json())
                .then(data => {
                    const adminSelect = document.getElementById('nuevoAdminSelect');
                    adminSelect.innerHTML = '';
                    data.admins.forEach(admin => {
                        const option = document.createElement('option');
                        option.value = admin.ID_Admin;
                        option.text = admin.Nombre;
                        adminSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error al obtener el administrador:', error));
        }
    </script>

    <%- include('includes/footer') %>
</body>
</html>
